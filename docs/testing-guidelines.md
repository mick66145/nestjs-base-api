# 測試指南

本指南為 相關功能的測試提供規範，確保程式碼的正確性、穩定性和品質。

## 通用原則

- **測試覆蓋率**: 盡可能提高測試覆蓋率，特別是對於核心業務邏輯和 演算法。
- **測試類型**: 區分單元測試 (Unit Tests)、整合測試 (Integration Tests) 和端對端測試 (End-to-End Tests)。
- **可重複性**: 測試應該是獨立的，且在任何環境下執行都應得到相同結果。
- **速度**: 單元測試應快速執行，整合測試和端對端測試可能需要較長時間，但仍應優化以提高效率。
- **清晰性**: 測試程式碼應清晰易讀，如同生產程式碼一樣。

## 測試類型和必須新增的測試項目

### 1. 單元測試 (Unit Tests)

**目標**: 測試獨立的函式、方法或類別，隔離外部依賴。

**必須新增的測試項目**:

- **Service 層**: 所有 Service 類別的公共方法都應有單元測試。
  - 驗證方法是否正確處理輸入和輸出。
  - 驗證方法是否正確呼叫其依賴項 (例如 Prisma 服務或外部 API 服務)。
  - 驗證異常情況下的錯誤處理。
- **Data Aggregator (或任何複雜邏輯處理單元)**: 任何包含複雜資料轉換、計算或 演算法的核心邏輯都應有詳細的單元測試。
  - 針對不同輸入資料集，驗證輸出是否符合預期。
  - 測試邊界條件和異常輸入。
- **DTO / Validator**: 如果有自定義的驗證邏輯，應測試其驗證規則是否按預期工作。

### 2. 整合測試 (Integration Tests)

**目標**: 測試多個模組或服務之間的互動，包括資料庫、外部 API 等。

**必須新增的測試項目**:

- **Controller 層**: 測試 Controller 是否正確處理請求、調用 Service、返回正確的回應。
  - 測試 RESTful API 端點，包括 GET, POST, PUT, PATCH, DELETE 請求。
  - 驗證請求參數的驗證 (例如 DTO 驗證器) 是否生效。
  - 驗證權限和身份驗證機制是否正常工作。
- **Service 與資料庫**: 測試 Service 與實際資料庫 (例如 PostgreSQL 透過 Prisma) 的互動是否正確。
  - 驗證資料的創建、讀取、更新、刪除 (CRUD) 操作。
  - 測試複雜查詢和事務的正確性。

### 3. 端對端測試 (End-to-End Tests)

**目標**: 模擬用戶的真實行為，從 UI 或 API 層面測試整個應用程式流程。

**必須新增的測試項目**:

- **關鍵業務流程**: 測試 相關功能的完整業務流程。
  - 例如：從資料上傳、資料預處理、模型訓練觸發、預測結果獲取等端到端流程。
  - 驗證多個模組協同工作是否正確。
- **常見用戶場景**: 針對最常見的用戶使用場景編寫測試，確保核心功能始終可用。

## 測試工具

- **Jest**: 作為主要的測試框架，用於單元測試和整合測試。
- **Supertest**: 用於 API 的整合測試和端對端測試。

## 測試程式碼風格

- 測試檔案應放在與被測試檔案相近的位置，例如 `src/dataset/__tests__/dataset.service.spec.ts`。
- 測試檔案命名應遵循 `*.spec.ts` 或 `*.e2e-spec.ts` 的慣例。
- 測試描述 (describe, it) 應清晰明確，表達測試的意圖和預期結果。

## Mocking 和 Stubbing

- 在單元測試中，應對外部依賴 (如資料庫、外部 API、其他服務) 進行 Mock 或 Stub，以隔離被測試單元。
- 使用 Jest 的 `jest.fn()` 或 `jest.spyOn()` 來創建 Mock 函式或監控方法調用。

## 測試資料

- 測試資料應獨立於生產資料，並在測試開始前設定 (setup) 和測試結束後清除 (teardown)。
- 避免測試之間相互依賴測試資料。
